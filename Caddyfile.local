# HYBRID MODE: HTTPS proxy for native Next.js
# Caddy runs in Docker, Next.js runs natively on host
# Uses host.docker.internal to reach host machine

{
    # Global options
    auto_https disable_redirects
}

# Primary: local.villa.cash (recommended for passkeys)
local.villa.cash:443 {
    tls internal

    header {
        X-Forwarded-Proto https
        X-Villa-Env local
    }

    # Health check - respond before proxying
    @health path /caddy-health
    handle @health {
        respond "OK" 200
    }

    # All other requests go to Next.js
    handle {
        reverse_proxy host.docker.internal:3000
    }
}

# Fallback: localhost (also works)
localhost:443 {
    tls internal

    header {
        X-Forwarded-Proto https
        X-Villa-Env local
    }

    # Health check
    @health path /caddy-health
    handle @health {
        respond "OK" 200
    }

    # All other requests go to Next.js
    handle {
        reverse_proxy host.docker.internal:3000
    }
}
