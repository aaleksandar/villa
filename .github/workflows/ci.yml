name: CI Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  determine-tests:
    name: "ðŸ” Determine Tests"
    runs-on: ubuntu-latest
    outputs:
      e2e: ${{ steps.filter.outputs.e2e }}
      unit: ${{ steps.filter.outputs.unit }}
      docs-only: ${{ steps.filter.outputs.docs-only }}
      sdk: ${{ steps.filter.outputs.sdk }}
    steps:
      - uses: actions/checkout@v4

      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            e2e:
              - 'apps/hub/src/**'
              - 'apps/hub/tests/**'
              - 'packages/sdk/**'
              - 'playwright.config.ts'
              - 'bun.lock'
            unit:
              - 'apps/hub/src/**'
              - 'packages/**'
              - 'vitest.config.*.ts'
              - 'bun.lock'
            docs-only:
              - '**/*.md'
              - 'docs/**'
              - '.claude/**'
              - '.opencode/**'
              - 'specs/**'
            sdk:
              - 'packages/sdk/**'
              - 'packages/sdk-react/**'

  lockfile-check:
    name: "ðŸ”’ Lockfile Sync"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Verify lockfile is in sync
        run: |
          if ! bun install --frozen-lockfile > /dev/null 2>&1; then
            echo "âŒ bun.lock is out of sync!"
            echo "Fix: Run 'bun install' locally and commit bun.lock"
            bun install --frozen-lockfile 2>&1 || true
            exit 1
          fi
          echo "âœ… Lockfile is in sync"

  lint:
    name: Lint and Type Check
    runs-on: ubuntu-latest
    needs: [lockfile-check]
    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: node_modules
          key: deps-${{ runner.os }}-${{ hashFiles('**/bun.lock') }}
          restore-keys: deps-${{ runner.os }}-

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Run ESLint and TypeScript in parallel
        run: bun run lint & bun run typecheck & wait

  build:
    name: Build
    runs-on: ubuntu-latest
    needs: [lockfile-check]
    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: node_modules
          key: deps-${{ runner.os }}-${{ hashFiles('**/bun.lock') }}
          restore-keys: deps-${{ runner.os }}-

      - name: Cache Next.js build
        uses: actions/cache@v4
        with:
          path: apps/hub/.next/cache
          key: nextjs-${{ runner.os }}-${{ hashFiles('**/bun.lock') }}-${{ hashFiles('apps/hub/src/**') }}
          restore-keys: |
            nextjs-${{ runner.os }}-${{ hashFiles('**/bun.lock') }}-
            nextjs-${{ runner.os }}-

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Build application
        run: bun run build

  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: [lockfile-check, determine-tests]
    if: needs.determine-tests.outputs.unit == 'true'
    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: node_modules
          key: deps-${{ runner.os }}-${{ hashFiles('**/bun.lock') }}
          restore-keys: deps-${{ runner.os }}-

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Run unit tests
        run: cd apps/hub && bun run test:unit

  security-scan:
    name: Security Scanning
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Gitleaks Secret Scan
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  validate-context:
    name: Validate Agent Context
    runs-on: ubuntu-latest
    needs: [lockfile-check]
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: node_modules
          key: deps-${{ runner.os }}-${{ hashFiles('**/bun.lock') }}
          restore-keys: deps-${{ runner.os }}-

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Validate agent definitions
        run: cd apps/hub && node --import tsx ../../.claude/rag/loader.ts validate

  validate-specs:
    name: Validate Specifications
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4

      - name: Check spec format
        run: |
          for file in specs/**/*.md; do
            if [[ -f "$file" ]]; then
              if ! head -1 "$file" | grep -q "^# "; then
                echo "ERROR: $file missing title"
                exit 1
              fi
            fi
          done
          echo "All specs have valid format"

  quality-metrics:
    name: Quality Metrics
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: node_modules
          key: deps-${{ runner.os }}-${{ hashFiles('**/bun.lock') }}
          restore-keys: deps-${{ runner.os }}-

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Generate quality report
        run: |
          echo "## Quality Metrics" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          LINES=$(find apps/hub/src packages -name "*.ts" -o -name "*.tsx" | xargs wc -l | tail -1 | awk '{print $1}')
          echo "| Lines of Code | $LINES |" >> $GITHUB_STEP_SUMMARY
          FILES=$(find apps/hub/src packages -name "*.ts" -o -name "*.tsx" | wc -l)
          echo "| TypeScript Files | $FILES |" >> $GITHUB_STEP_SUMMARY
