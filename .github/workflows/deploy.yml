name: Deploy

on:
  push:
    branches: [main]
    tags: ["v*"]
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened, closed, ready_for_review]

permissions:
  contents: write
  pull-requests: write
  deployments: write

concurrency:
  group: deploy-${{ github.event_name == 'pull_request' && format('pr-{0}', github.event.pull_request.number) || github.ref_name }}
  cancel-in-progress: true

env:
  PRODUCTION_DOMAIN: villa.cash
  STAGING_DOMAIN: beta.villa.cash

jobs:
  # =============================================================================
  # CHANGE DETECTION - Determine what needs to be built/deployed
  # =============================================================================
  detect-changes:
    name: "ðŸ” Detect Changes"
    runs-on: ubuntu-latest
    outputs:
      hub: ${{ steps.filter.outputs.hub }}
      sdk: ${{ steps.filter.outputs.sdk }}
      docs: ${{ steps.filter.outputs.docs }}
      any-app: ${{ steps.any.outputs.result }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            hub:
              - 'apps/hub/**'
              - 'packages/**'
              - 'Dockerfile'
              - '.do/app-*.yaml'
            sdk:
              - 'packages/sdk/**'
              - 'packages/sdk-react/**'
            docs:
              - 'apps/developers/**'
              - '**/*.md'

      - name: Check if any app changed
        id: any
        run: |
          if [[ "${{ steps.filter.outputs.hub }}" == "true" ]] || \
             [[ "${{ steps.filter.outputs.sdk }}" == "true" ]] || \
             [[ "${{ steps.filter.outputs.docs }}" == "true" ]]; then
            echo "result=true" >> $GITHUB_OUTPUT
          else
            echo "result=false" >> $GITHUB_OUTPUT
          fi

  # =============================================================================
  # QUICK CI - Fast feedback for PRs (~30s)
  # =============================================================================
  quick-ci:
    name: "âš¡ Quick CI"
    if: github.event_name == 'pull_request' && github.event.action != 'closed'
    runs-on: ubuntu-latest
    outputs:
      should-e2e: ${{ steps.check-paths.outputs.run }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup test environment
        uses: ./.github/actions/setup-test-env
        with:
          install-playwright: "false"

      - name: Run linting and type checking
        run: bun run typecheck && bun run lint

      - name: Check if E2E needed
        id: check-paths
        run: |
          CHANGED=$(git diff --name-only origin/${{ github.base_ref }}...HEAD 2>/dev/null || echo "src/")
          if echo "$CHANGED" | grep -qE '^(apps/|packages/|tests/|playwright)'; then
            echo "run=true" >> $GITHUB_OUTPUT
          else
            echo "run=false" >> $GITHUB_OUTPUT
            echo "ðŸ“ Skipping E2E - only docs/config changes"
          fi

  # =============================================================================
  # E2E TESTS - Sharded parallel execution (PRs only)
  # =============================================================================
  e2e-tests:
    name: "ðŸ§ª E2E (Shard ${{ matrix.shard }}/4)"
    needs: quick-ci
    if: |
      github.event_name == 'pull_request' &&
      github.event.action != 'closed' &&
      github.event.pull_request.draft == false &&
      needs.quick-ci.outputs.should-e2e == 'true' &&
      !contains(github.event.pull_request.title, '[wip]') &&
      !contains(github.event.pull_request.title, '[skip e2e]')
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        shard: [1, 2, 3, 4]
    steps:
      - uses: actions/checkout@v4

      - name: Setup test environment
        uses: ./.github/actions/setup-test-env
        with:
          install-playwright: "true"
          playwright-browser: "chromium"

      - name: Run E2E tests (shard ${{ matrix.shard }}/4)
        run: cd apps/hub && npx playwright test --project=chromium --shard=${{ matrix.shard }}/4
        env:
          CI: true

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: e2e-report-shard-${{ matrix.shard }}
          path: |
            apps/hub/playwright-report/
            apps/hub/test-results/
          retention-days: 7

  # =============================================================================
  # MERGE E2E REPORTS
  # =============================================================================
  merge-e2e-reports:
    name: "ðŸ“Š Merge E2E Reports"
    needs: e2e-tests
    if: always() && needs.e2e-tests.result != 'skipped'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup test environment
        uses: ./.github/actions/setup-test-env
        with:
          install-playwright: "true"
          playwright-browser: "chromium"

      - name: Download all shard reports
        uses: actions/download-artifact@v4
        with:
          pattern: e2e-report-shard-*
          path: all-reports/
          merge-multiple: false

      - name: Merge Playwright reports
        run: cd apps/hub && npx playwright merge-reports --reporter html ../../all-reports/e2e-report-shard-*
        continue-on-error: true

      - name: Upload merged report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: e2e-report-merged
          path: playwright-report/
          retention-days: 30

  # =============================================================================
  # CI - Runs on push to main and tags (shared job)
  # =============================================================================
  ci:
    name: "ðŸ”’ CI"
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Cache Bun dependencies
        uses: actions/cache@v4
        id: cache-deps
        with:
          path: |
            node_modules
            ~/.bun/install/cache
          key: bun-${{ runner.os }}-${{ hashFiles('**/bun.lock') }}
          restore-keys: bun-${{ runner.os }}-

      - name: Cache Next.js build
        uses: actions/cache@v4
        with:
          path: |
            apps/hub/.next/cache
            apps/developers/.next/cache
          key: nextjs-${{ runner.os }}-${{ hashFiles('**/bun.lock') }}-${{ hashFiles('apps/*/src/**') }}
          restore-keys: |
            nextjs-${{ runner.os }}-${{ hashFiles('**/bun.lock') }}-
            nextjs-${{ runner.os }}-

      - name: Install dependencies
        if: steps.cache-deps.outputs.cache-hit != 'true'
        run: bun install --frozen-lockfile

      - name: Restore dependencies from lockfile
        if: steps.cache-deps.outputs.cache-hit == 'true'
        run: bun install --frozen-lockfile

      - name: Run checks in parallel
        run: bun run typecheck & bun run lint & wait

  # =============================================================================
  # DEPLOY STAGING - To beta.villa.cash on push to main
  # =============================================================================
  deploy-staging:
    name: "ðŸŽ¯ Deploy Staging"
    needs: ci
    if: github.ref == 'refs/heads/main' && !startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    outputs:
      url: ${{ steps.deploy.outputs.url }}
      build-id: ${{ steps.wait-build.outputs.build-id }}
    environment:
      name: staging
      url: https://beta.villa.cash
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

      - name: Get staging info
        id: staging-info
        run: |
          echo "sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          echo "msg=$(git log -1 --pretty=%s | head -c 50)" >> $GITHUB_OUTPUT

      - name: Generate staging spec
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          export DATABASE_URL
          export MINTER_PRIVATE_KEY="${{ secrets.DEPLOYER_PRIVATE_KEY }}"
          envsubst '${DATABASE_URL} ${MINTER_PRIVATE_KEY}' < .do/app-staging.yaml > .do/app-staging-generated.yaml

      - name: Deploy to beta.villa.cash
        id: deploy
        run: |
          APP_ID=$(doctl apps list --format ID,Spec.Name --no-header | grep "villa-staging$" | awk '{print $1}')

          if [ -z "$APP_ID" ]; then
            doctl apps create --spec .do/app-staging-generated.yaml
            echo "url=https://beta.villa.cash" >> $GITHUB_OUTPUT
            exit 0
          fi

          OLD_DEPLOYMENT_ID=$(doctl apps get $APP_ID --output json | jq -r '.[0].active_deployment.id // empty')
          echo "Current deployment: $OLD_DEPLOYMENT_ID"

          doctl apps update $APP_ID --spec .do/app-staging-generated.yaml

          doctl apps create-deployment $APP_ID --force-rebuild --wait=false || true

          echo "url=https://beta.villa.cash" >> $GITHUB_OUTPUT
          echo "app-id=$APP_ID" >> $GITHUB_OUTPUT
          echo "old-deployment-id=$OLD_DEPLOYMENT_ID" >> $GITHUB_OUTPUT

      - name: Wait for build to complete
        timeout-minutes: 15
        continue-on-error: true
        id: wait-build
        run: |
          APP_ID="${{ steps.deploy.outputs.app-id }}"
          OLD_DEPLOYMENT_ID="${{ steps.deploy.outputs.old-deployment-id }}"

          if [ -z "$APP_ID" ]; then
            APP_ID=$(doctl apps list --format ID,Spec.Name --no-header | grep "villa-staging$" | awk '{print $1}')
          fi

          echo "Old deployment was: $OLD_DEPLOYMENT_ID"

          for i in {1..90}; do
            APP_JSON=$(doctl apps get $APP_ID --output json 2>/dev/null)
            
            IN_PROGRESS_PHASE=$(echo "$APP_JSON" | jq -r '.[0].in_progress_deployment.phase // empty')
            
            if [ -n "$IN_PROGRESS_PHASE" ]; then
              echo "â³ Building: $IN_PROGRESS_PHASE ($i/90)"
              sleep 10
              continue
            fi
            
            ACTIVE_ID=$(echo "$APP_JSON" | jq -r '.[0].active_deployment.id // empty')
            ACTIVE_PHASE=$(echo "$APP_JSON" | jq -r '.[0].active_deployment.phase // empty')
            
            if [ "$ACTIVE_PHASE" = "ACTIVE" ] && [ "$ACTIVE_ID" != "$OLD_DEPLOYMENT_ID" ]; then
              echo "âœ… Staging build complete (deployment: $ACTIVE_ID)"
              echo "build-id=$ACTIVE_ID" >> $GITHUB_OUTPUT
              exit 0
            fi
            
            echo "â³ Waiting for new deployment... ($i/90)"
            sleep 10
          done
          echo "âš ï¸ Build timeout - continuing with smoke test"
          exit 0

      - name: Purge CloudFlare cache
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ZONE_ID: ${{ secrets.CLOUDFLARE_ZONE_ID }}
        run: |
          if [ -n "$CLOUDFLARE_API_TOKEN" ] && [ -n "$CLOUDFLARE_ZONE_ID" ]; then
            curl -X POST "https://api.cloudflare.com/client/v4/zones/${CLOUDFLARE_ZONE_ID}/purge_cache" \
              -H "Authorization: Bearer ${CLOUDFLARE_API_TOKEN}" \
              -H "Content-Type: application/json" \
              --data '{"hosts":["beta.villa.cash"]}' || true
          fi

      - name: Smoke test
        run: |
          for i in {1..10}; do
            if curl -sf "https://beta.villa.cash/api/health" > /dev/null; then
              echo "âœ… Staging healthy"
              exit 0
            fi
            sleep 5
          done
          exit 1

      - name: Comment on commit
        uses: actions/github-script@v7
        with:
          script: |
            const sha = '${{ steps.staging-info.outputs.sha }}';
            const msg = '${{ steps.staging-info.outputs.msg }}';

            await github.rest.repos.createCommitComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: context.sha,
              body: `ðŸŽ¯ **Deployed to staging** â€¢ [beta.villa.cash](https://beta.villa.cash) â€¢ \`${sha}\`\n\n_${msg}_`
            });

  # =============================================================================
  # DEPLOY PRODUCTION - To villa.cash on release tags
  # =============================================================================
  deploy-production:
    name: "ðŸŽ‰ Deploy Production"
    needs: ci
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    outputs:
      url: ${{ steps.deploy.outputs.url }}
    environment:
      name: production
      url: https://villa.cash
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

      - name: Get release info
        id: release-info
        run: |
          TAG_NAME="${{ github.ref_name }}"
          echo "tag=${TAG_NAME}" >> $GITHUB_OUTPUT
          echo "version=${TAG_NAME#v}" >> $GITHUB_OUTPUT
          echo "sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Generate production spec
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          export DATABASE_URL
          export MINTER_PRIVATE_KEY="${{ secrets.DEPLOYER_PRIVATE_KEY }}"
          envsubst '${DATABASE_URL} ${MINTER_PRIVATE_KEY}' < .do/app-production.yaml > .do/app-production-generated.yaml

      - name: Deploy to villa.cash
        id: deploy
        run: |
          APP_ID=$(doctl apps list --format ID,Spec.Name --no-header | grep "villa-production$" | awk '{print $1}')

          if [ -z "$APP_ID" ]; then
            doctl apps create --spec .do/app-production-generated.yaml
            echo "url=https://villa.cash" >> $GITHUB_OUTPUT
            exit 0
          fi

          OLD_DEPLOYMENT_ID=$(doctl apps get $APP_ID --output json | jq -r '.[0].active_deployment.id // empty')
          echo "Current deployment: $OLD_DEPLOYMENT_ID"

          doctl apps update $APP_ID --spec .do/app-production-generated.yaml

          doctl apps create-deployment $APP_ID --force-rebuild --wait=false || true

          echo "url=https://villa.cash" >> $GITHUB_OUTPUT
          echo "app-id=$APP_ID" >> $GITHUB_OUTPUT
          echo "old-deployment-id=$OLD_DEPLOYMENT_ID" >> $GITHUB_OUTPUT

      - name: Wait for build to complete
        timeout-minutes: 15
        continue-on-error: true
        id: wait-build
        run: |
          APP_ID="${{ steps.deploy.outputs.app-id }}"
          OLD_DEPLOYMENT_ID="${{ steps.deploy.outputs.old-deployment-id }}"

          if [ -z "$APP_ID" ]; then
            APP_ID=$(doctl apps list --format ID,Spec.Name --no-header | grep "villa-production$" | awk '{print $1}')
          fi

          echo "Old deployment was: $OLD_DEPLOYMENT_ID"

          for i in {1..90}; do
            APP_JSON=$(doctl apps get $APP_ID --output json 2>/dev/null)
            
            IN_PROGRESS_PHASE=$(echo "$APP_JSON" | jq -r '.[0].in_progress_deployment.phase // empty')
            
            if [ -n "$IN_PROGRESS_PHASE" ]; then
              echo "â³ Building: $IN_PROGRESS_PHASE ($i/90)"
              sleep 10
              continue
            fi
            
            ACTIVE_ID=$(echo "$APP_JSON" | jq -r '.[0].active_deployment.id // empty')
            ACTIVE_PHASE=$(echo "$APP_JSON" | jq -r '.[0].active_deployment.phase // empty')
            
            if [ "$ACTIVE_PHASE" = "ACTIVE" ] && [ "$ACTIVE_ID" != "$OLD_DEPLOYMENT_ID" ]; then
              echo "âœ… Production build complete (deployment: $ACTIVE_ID)"
              exit 0
            fi
            
            echo "â³ Waiting for new deployment... ($i/90)"
            sleep 10
          done
          echo "âš ï¸ Build timeout - continuing with smoke test"
          exit 0

      - name: Purge CloudFlare cache
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ZONE_ID: ${{ secrets.CLOUDFLARE_ZONE_ID }}
        run: |
          if [ -n "$CLOUDFLARE_API_TOKEN" ] && [ -n "$CLOUDFLARE_ZONE_ID" ]; then
            curl -X POST "https://api.cloudflare.com/client/v4/zones/${CLOUDFLARE_ZONE_ID}/purge_cache" \
              -H "Authorization: Bearer ${CLOUDFLARE_API_TOKEN}" \
              -H "Content-Type: application/json" \
              --data '{"hosts":["villa.cash","www.villa.cash"]}' || true
          fi

      - name: Smoke test production
        run: |
          for i in {1..10}; do
            if curl -sf "https://villa.cash/api/health" > /dev/null; then
              BUILD_ID=$(curl -s https://villa.cash | grep -o '"buildId":"[^"]*"' | head -1)
              echo "âœ… Production healthy - $BUILD_ID"
              exit 0
            fi
            sleep 5
          done
          exit 1

      - name: Create GitHub Release
        uses: actions/github-script@v7
        with:
          script: |
            const tag = '${{ steps.release-info.outputs.tag }}';
            const sha = '${{ steps.release-info.outputs.sha }}';
            const { owner, repo } = context.repo;

            const { data: comparison } = await github.rest.repos.compareCommits({
              owner, repo,
              base: 'HEAD~10',
              head: tag
            }).catch(() => ({ data: { commits: [] } }));

            const changelog = comparison.commits
              .slice(0, 10)
              .map(c => `- ${c.commit.message.split('\n')[0]}`)
              .join('\n');

            const body = `## ðŸŽ‰ Villa ${tag}\n\nLive at **[villa.cash](https://villa.cash)**\n\n### Changes\n${changelog}\n\n---\nCommit: \`${sha}\``;

            try {
              await github.rest.repos.createRelease({
                owner, repo,
                tag_name: tag,
                name: `Villa ${tag}`,
                body,
                draft: false,
                prerelease: false
              });
              console.log(`Created release ${tag}`);
            } catch (e) {
              if (e.status === 422 && e.message.includes('already_exists')) {
                console.log(`Release ${tag} already exists, skipping creation`);
              } else {
                throw e;
              }
            }

  # =============================================================================
  # PR MERGED NOTIFICATION
  # =============================================================================
  pr-merged:
    name: "ðŸŽ‰ PR Merged"
    if: github.event_name == 'pull_request' && github.event.action == 'closed' && github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    steps:
      - name: Comment on merged PR
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `ðŸŽ‰ Merged! Changes will auto-deploy to [beta.villa.cash](https://beta.villa.cash).\n\nCreate \`v*\` tag to deploy to production.`
            });
