name: Documentation

on:
  push:
    branches: [main]
    paths:
      - "packages/sdk/**"
      - "packages/sdk-react/**"
      - "scripts/docs/**"
      - "typedoc.json"
  pull_request:
    branches: [main]
    paths:
      - "packages/sdk/**"
      - "packages/sdk-react/**"
      - "scripts/docs/**"
      - "typedoc.json"
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  generate-docs:
    name: "ðŸ“š Generate Documentation"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Generate CLAUDE.txt
        run: bun run docs:claude

      - name: Generate API docs
        run: bun run docs:api

      - name: Check for changes
        id: changes
        run: |
          git add -N .
          if git diff --quiet packages/sdk/CLAUDE.txt apps/developers/public/CLAUDE.txt; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      - name: Commit documentation updates
        if: github.event_name == 'push' && github.ref == 'refs/heads/main' && steps.changes.outputs.changed == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add packages/sdk/CLAUDE.txt apps/developers/public/CLAUDE.txt
          git commit -m "docs: auto-generate CLAUDE.txt [skip ci]" || true
          git push || true

      - name: Comment on PR
        if: github.event_name == 'pull_request' && steps.changes.outputs.changed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'ðŸ“š **Documentation Update Detected**\n\nThis PR includes changes to SDK source files. CLAUDE.txt will be auto-regenerated when merged to main.'
            })

  validate-docs:
    name: "âœ… Validate Documentation"
    runs-on: ubuntu-latest
    needs: generate-docs
    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Verify CLAUDE.txt exists and has content
        run: |
          if [ ! -f packages/sdk/CLAUDE.txt ]; then
            echo "ERROR: packages/sdk/CLAUDE.txt not found"
            exit 1
          fi

          LINES=$(wc -l < packages/sdk/CLAUDE.txt)
          if [ "$LINES" -lt 100 ]; then
            echo "ERROR: CLAUDE.txt has only $LINES lines (expected 100+)"
            exit 1
          fi

          echo "âœ“ CLAUDE.txt validated: $LINES lines"

      - name: Verify key sections present
        run: |
          REQUIRED_SECTIONS=(
            "Quick Reference"
            "One-Prompt Integration"
            "TypeScript Types"
            "Error Handling"
            "Troubleshooting"
          )

          for section in "${REQUIRED_SECTIONS[@]}"; do
            if ! grep -q "$section" packages/sdk/CLAUDE.txt; then
              echo "ERROR: Missing required section: $section"
              exit 1
            fi
          done

          echo "âœ“ All required sections present"
