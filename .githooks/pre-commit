#!/bin/bash
# Pre-commit hook: Verify pnpm-lock.yaml is in sync
#
# Catches the most common contributor error: modifying package.json
# without running `pnpm install` to update the lock file.

set -e

# Skip if no package.json files are staged
if ! git diff --cached --name-only | grep -qE 'package\.json$'; then
  exit 0
fi

echo "üì¶ Checking pnpm-lock.yaml sync..."

# Check if pnpm-lock.yaml is also staged when package.json changes
if ! git diff --cached --name-only | grep -q 'pnpm-lock.yaml'; then
  echo ""
  echo "‚ö†Ô∏è  package.json changed but pnpm-lock.yaml not staged!"
  echo ""
  echo "Run: pnpm install && git add pnpm-lock.yaml"
  echo ""
  echo "This ensures the lock file stays in sync with dependencies."
  echo "To bypass (not recommended): git commit --no-verify"
  exit 1
fi

# Verify lock file is actually in sync
if ! pnpm install --frozen-lockfile --ignore-scripts > /dev/null 2>&1; then
  echo ""
  echo "‚ùå pnpm-lock.yaml is out of sync with package.json files!"
  echo ""
  echo "Run: pnpm install && git add pnpm-lock.yaml"
  echo ""
  exit 1
fi

echo "‚úÖ Lock file is in sync"
exit 0
